<!DOCTYPE html>
<html lang="en" style="height: 100%; margin: 0;">

<head>
    <title>Bubblesets - Cliques</title>
    <meta charset="utf-8">
    <!-- bubbleset js  -->
    <script src="bubblesets.js" charset="utf-8"></script>
    <!-- d3.js CDN -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<style>
    /* d3 circle popout data */
    div.tooltip {
        position: absolute;
        width: 750px;
        padding: 17px;
        font: 30px sans-serif;
        background: lightsteelblue;
        border: 0px;
        border-radius: 20px;
        pointer-events: none;
    }

    /* label rect */
    img.labelrect {
        width: 30px;
        height: 30px;
        margin: 20px;
        margin-bottom: auto;
    }

    /* scale to resize iframe of mainpage */
    body {
        transform-origin: top left;
        transform: scale(0.47);
    }
</style>

<body>
</body>
<script>
    // d3.js start
    var mult = 2.5;
    var w = 1400*mult, h = 700*mult, padding = 50, radius = 5;

    var svg = d3.select('body').append('svg')
        .style('width', w + 'px')
        .style('height', h + 'px')
        .attr('class', 'svg')

    var rect = d3.select('body').select('svg').append('rect')
        .style('width', '100%')
        .style('height', '100%')
        .style('stroke', 'black')
        .style('stroke-width', '1')
        .style('fill', 'none')
        .attr('class', 'rect')

    var div = d3.select("body").append("div")
        .attr("class", "tooltip")
        .style("opacity", 0);

    dataurl = "./data/top_cast.csv";

    d3.csv(dataurl).then((data) => {
        console.log(data);
        dataset = data;

        // var Xmax = d3.max(dataset, function (d) { return d.ROI }),
        //     Xmin = d3.min(dataset, function (d) { return d.ROI });
        var Xmax = 100, Xmin = -100

        // var Ymax = d3.max(dataset, function (d) { return d.popularity }),
        //     Ymin = d3.min(dataset, function (d) { return d.popularity });
        var Ymax = 170, Ymin = 3

        console.log("Xmin:" + Xmin);
        console.log("Xmax:" + Xmax);
        console.log("Ymin:" + Ymin);
        console.log("Ymax:" + Ymax);

        var xScale = d3.scaleLinear()
            .domain([Xmin, Xmax])
            .range([padding, w - padding]);

        // yScale = d3.scaleLinear()
        yScale = d3.scaleLog()
            .domain([Ymin, Ymax])
            .range([h - padding, padding]);

        svg.selectAll('circle').data(dataset).enter()
            .append('circle')
            .attr("r", radius)
            .attr("cx", (d, i) => xScale(d.ROI))
            .attr("cy", (d, i) => yScale(d.popularity))
            .attr("class", (d, i) => d.cast_names.replaceAll("," , ""))
            .style("fill", "black")
            .on("mouseover", function (event, d) {
                div.transition()
                    .duration(200)
                    .style("opacity", .9);
                div.html("Title: " + d.title
                    + "<br/> Budget: " + (d.budget / 1000) + "K"
                    + "<br/> Genre: " + d.genres
                    + "<br/> Vote Average: " + d.vote_average
                    + "<br/> Vote Count: " + d.vote_count)
                    // for scale of mainpage: event.pageXY/body.scale + modify
                    .style("left", (event.pageX/0.47) + "px")
                    .style("top", (event.pageY/0.47) + "px");

            })
            .on("mouseout", function (d) {
                div.transition()
                    .duration(500)
                    .style("opacity", 0);
            });

        var xAxis = d3.axisBottom(xScale)
        var yAxis = d3.axisLeft(yScale)

        svg.append('g').attr('class', 'axis')
            .attr('transform', 'translate(0, ' + (h - padding) + ')')
            .style("font-size", "20px")
            .call(xAxis)

        svg.append("text")
            .attr("transform",
                "translate(" + (w / 2) + " ," +
                (h - 1) + ")")
            .style("text-anchor", "middle")
            .style("font-size", "30px")
            .text("ROI");

        svg.append('g').attr('class', 'axis')
            .attr('transform', 'translate(' + padding + ', 0)')
            .style("font-size", "20px")
            .call(yAxis)

        svg.append("text")
            .attr("transform", "rotate(-90)")
            .attr("y", 0)
            .attr("x", 30 - (h / 2))
            .attr("dy", "1em")
            .style("text-anchor", "middle")
            .style("font-size", "30px")
            .text("Popularity");

        // run bubble set IMMEDIATELY after d3.js finish (because d3.csv is asyncronous)
        startBubbleSet();
    }) // d3.js end

    // Generate Random Color distinguishable to Humans
    function makeColor(colorNum, colors) {
        if (colors < 1) colors = 1; // defaults to one color - avoid divide by zero
        return colorNum * (360 / colors) % 360;
    }

    // bubble-sets start
    function startBubbleSet() {
        // generate bubble sets, variable of bubblesets
        var pad = 3;
        var nodesize = 1;
        var bubbles = new BubbleSet();

        var svgnode = document.getElementsByClassName('svg')[0];
        var rectnode = document.getElementsByClassName('rect')[0];
        var bodynode = document.getElementsByTagName('body')[0];

        var cast_names = ['Bruce Willis', 'Matt Damon', 'Nicolas Cage', 'Robert De Niro', 'Samuel L Jackson'];
        var paths = [];
        var pointSets = [];
        var totalColors = cast_names.length;

        // Generate paths and colors of paths by cast_names
        cast_names.forEach(function callback(cast_name, index) {
            var path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            path.id = cast_name;
            path.setAttributeNS(null, "fill", "hsl(" + makeColor(index, totalColors) + ", 100%, 50% )");
            path.setAttributeNS(null, "opacity", 0.5);
            path.setAttributeNS(null, "stroke", "black");
            paths.push(path);
            // insert before circle to not block the data popout
            svgnode.insertBefore(path, rectnode);

            // each cast_name 1 rectangle
            set = []
            pointSets.push(set);
        })

        console.log(paths);
        console.log(pointSets);

        // give every node of data a coord & type to use in bubble-sets
        var nodeList = document.getElementsByTagName('svg')[0].childNodes;
        console.log(nodeList);

        // add every circle coordinate of d3.js to list
        nodeList.forEach(function (node, index) {
            // console.log(node.className)
            if (node.nodeName == "circle") {
                var coords = {
                    "x": node.cx.baseVal.value,
                    "y": node.cy.baseVal.value,
                    "width": nodesize,
                    "height": nodesize
                };
                // iterate every cast_name of node
                cast_names.forEach(function callback(cast_name, index) {
                    if (node.className.baseVal.includes(cast_name)) {
                        var gIndex = cast_names.indexOf(cast_name);
                        if (gIndex != -1) pointSets[gIndex].push(coords);
                    }
                })
            }
        });

        console.log(pointSets);

        // make a path of bubble set
        function doBubbles(points, others, elem) {
            var list = bubbles.createOutline(
                BubbleSet.addPadding(points, pad),
                BubbleSet.addPadding(others, pad),
                null
            );
            var outline = new PointPath(list).transform([
                new ShapeSimplifier(0.0),
                new BSplineShapeGenerator(),
                new ShapeSimplifier(0.0),
            ]);
            elem.setAttributeNS(null, "d", outline);
            // hide bubbleset at start
            elem.style.display = "none";
        }

        function getOtherSets(targetSet, allSets) {
            let otherSets = [];
            allSets.forEach(function callback(set, index) {
                if (targetSet != set) otherSets = [...otherSets, ...set];
            });
            return otherSets;
        }

        // run every path
        pointSets.forEach(function callback(set, index) {
            let otherSets = getOtherSets(set, pointSets);
            let path = paths[index];
            doBubbles(set, otherSets, path);
        })
        // bubble sets generated

        // give every cast_name/path a checkbox

        bodynode.append(document.createElement('br'));
        var divnode = document.createElement('div');
        divnode.style.display = "flex";
        bodynode.append(divnode);

        bodynode.append(document.createElement('br'));
        var divnode2 = document.createElement('div');
        divnode2.style.display = "flex";
        bodynode.append(divnode2);

        bodynode.append(document.createElement('br'));
        var divnode3 = document.createElement('div');
        divnode3.style.display = "flex";
        bodynode.append(divnode3);

        bodynode.append(document.createElement('br'));
        var divnode4 = document.createElement('div');
        divnode4.style.display = "flex";
        bodynode.append(divnode4);

        paths.forEach(function callback(path, index) {
            var checkbox = document.createElement('input');
            checkbox.type = "checkbox";
            checkbox.addEventListener('click', function (event) {
                let path = document.getElementById(cast_names[index]);
                if (checkbox.checked) path.style.display = "initial";
                else path.style.display = "none";
            })
            checkbox.click();

            var label = document.createElement('label')
            label.appendChild(document.createTextNode(cast_names[index]));

            var rect = document.createElement('img');
            rect.className = "labelrect";
            rect.style.backgroundColor = "hsl(" + makeColor(index, totalColors) + ", 100%, 50% )";

            var div = document.createElement('div');
            div.style.flex = 1;
            if (index < 5) divnode.appendChild(div);
            else if (index < 10) divnode2.appendChild(div);
            else if (index < 15) divnode3.appendChild(div);
            else divnode4.appendChild(div);

            div.appendChild(checkbox);
            div.appendChild(rect);
            div.appendChild(label);
            div.appendChild(document.createElement('br'));
        });
    }

</script>

</body>

</html>